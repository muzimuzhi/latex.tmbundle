name: Run Tests
on: push

jobs:
  build:
    name: Test LaTeX Bundle
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Skim
        run: brew install --cask skim

      - name: Install and open TextMate
        run: |
          brew install TextMate
          mkdir -p "$HOME/Library/Application Support/TextMate"
          mkdir -p "$HOME/Library/Application Support/TextMate/Managed"
          mkdir -p "$HOME/Library/Application Support/TextMate/Managed/Bundles"
          pushd "$HOME/Library/Application Support/TextMate/Managed/Bundles"
          for bundle in css html java javascript javadoc python r sql; do
            gh repo clone "textmate/$bundle.tmbundle"
          done
          open /Applications/TextMate.app
          popd
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install BasicTeX
        run: |
          brew install basictex

      - name: Install TeX packages
        run: |
          eval "$(/usr/libexec/path_helper)"
          sudo tlmgr update --self
          sudo tlmgr install --with-doc \
            biber  \
            biblatex \
            csquotes \
            ctablestack \
            datatool \
            framed \
            glossaries \
            latexmk \
            logreq \
            luacode \
            mfirstuc \
            substr \
            supertabular \
            texdoc \
            texdoctk \
            upmethodology \
            xfor \
            xstring

      - name: Install Python
        uses: actions/setup-python@v4
        with:
           python-version: '3.10'

      - name: Install Prysk
        run: pip install prysk

      - name: Install Test Tools
        run: |
          brew install pidof
          brew install boost capnp google-sparsehash multimarkdown ninja ragel
          git clone --recursive https://github.com/textmate/textmate.git
          cd textmate
          ./configure && ninja gtm
          mv "$HOME/build/textmate/release/Applications/gtm/gtm" /usr/local/bin

      - name: Run Prysk Tests
        run: make prysktests
